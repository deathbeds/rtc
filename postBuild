conda env update --file automerge/environment.yml --prefix ${NB_PYTHON_PREFIX}

/bin/bash pushd automerge
    /bin/bash pushd rust
        make all
        pip list | grep jupyter-rtc-automerge
    /bin/bash popd


    git clone https://github.com/datalayer-contrib/automerge externals/automerge-wasm-bundler
    /bin/bash pushd externals/automerge-wasm-bundler
        git checkout wasm-bundler
    /bin/bash popd

    git clone https://github.com/datalayer-contrib/automerge externals/automerge-wasm-nodejs
    /bin/bash pushd externals/automerge-wasm-nodejs
        git checkout wasm-nodejs
    /bin/bash popd

    git clone https://github.com/datalayer-contrib/automerge externals/automerge && \
    /bin/bash pushd externals/automerge-wasm-nodejs
        git checkout performance-a262c
    /bin/bash popd

    git clone https://github.com/datalayer/jupyter-auth externals/jupyter-auth
    /bin/bash pushd externals/jupyter-auth
        pip install -e .
        jupyter labextension develop --overwrite
    /bin/bash popd

    /bin/bash pushd externals/automerge
        yarn
        yarn build
    /bin/bash popd

    rm -fr packages/jupyterlab-rtc/node_modules/automerge*
	rm -fr packages/server/node_modules/automerge*
	rm -fr packages/textarea/node_modules/automerge*

    pip install -e.



    pip uninstall -y jupyter-server

    git clone https://github.com/datalayer-contrib/jupyter-server externals/jupyter-server
    /bin/bash pushd externals/jupyter-auth
        git checkout sessions
        pip install -e .
    /bin/bash popd

    /bin/bash pushd jupyterlab-rtc
        jupyter labextension develop --overwrite
        jupyter labextension list
    /bin/bash popd

/bin/bash popd # take us out of automerge

pip install doit

python -m doit