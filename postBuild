mamba env update --file automerge/environment.yml --prefix ${NB_PYTHON_PREFIX}

pushd automerge
    pushd rust
        make all
        pip list | grep jupyter-rtc-automerge
    popd


    git clone https://github.com/datalayer-contrib/automerge externals/automerge-wasm-bundler
    pushd externals/automerge-wasm-bundler
        git checkout wasm-bundler
    popd

    git clone https://github.com/datalayer-contrib/automerge externals/automerge-wasm-nodejs
    pushd externals/automerge-wasm-nodejs
        git checkout wasm-nodejs
    popd

    git clone https://github.com/datalayer-contrib/automerge externals/automerge && \
    pushd externals/automerge-wasm-nodejs
        git checkout performance-a262c
    popd

    git clone https://github.com/datalayer/jupyter-auth externals/jupyter-auth
    pushd externals/jupyter-auth
        pip install -e .
        jupyter labextension develop --overwrite
    popd

    pushd externals/automerge
        yarn
        yarn build
    popd

    rm -fr packages/jupyterlab-rtc/node_modules/automerge*
	rm -fr packages/server/node_modules/automerge*
	rm -fr packages/textarea/node_modules/automerge*

    pip install -e.



    pip uninstall -y jupyter-server

    git clone https://github.com/datalayer-contrib/jupyter-server externals/jupyter-server
    pushd externals/jupyter-auth
        git checkout sessions
        pip install -e .
    popd

    pushd jupyterlab-rtc
        jupyter labextension develop --overwrite
        jupyter labextension list
    popd

popd # take us out of automerge

pip install doit

doit